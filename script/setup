#!/usr/bin/env bash
#
# Install all dotfiles into the home directory

# Go up to the parent of the script directory
cd "${BASH_SOURCE%/*}/.." || exit

# Set $DOTFILESDIR to the absolute path of the working directory
DOTFILESDIR=$(pwd -P)

# Set paths for dotfiles outside of $HOME
STARSHIP="$HOME/.config/"
case "$OSTYPE" in
"darwin"*) # macOS
  VSCODE="$HOME/Library/Application Support/Code/User/"
  ZOOM="/Library/Managed Preferences/"
  ;;
"linux"*) # Linux
  VSCODE="$HOME/.config/Code/User/"
  ;;
esac

# Include filenames beginning with a ‘.’ in the results of filename expansion
shopt -s dotglob

# Iterate over dotfiles
for DOTFILE in *; do
  # Set linked dotfile path
  HOMEFILE="$HOME/$DOTFILE"
  # Append ‘/’ to the name of directories
  [[ -d "$DOTFILE" ]] && DOTFILE+="/"
  # Set absolute dotfile path
  DIRFILE="$DOTFILESDIR/$DOTFILE"

  # Skip the script/ directory, LICENSE, and any .txt or .md files
  [[ $DOTFILE =~ (^script\/$|^LICENSE$|\.txt$|\.md$) ]] && continue

  # Configure dotfile-specific paths
  case "$DOTFILE" in
  *zoom*) HOMEFILE="/Library/Managed Preferences/$DOTFILE" && mkdir -p "$ZOOM" ;;
  *starship*) HOMEFILE="$STARSHIP/$DOTFILE" && mkdir -p "$STARSHIP" ;;
  *vscode-settings*) HOMEFILE="$VSCODE/settings.json" && mkdir -p "$VSCODE" ;;
  esac

  # If $HOMEFILE is a symbolic link and $DOTFILE is not a directory
  if [[ -L "$HOMEFILE" ]] && ! [[ -d "$DOTFILE" ]]; then
    # Create symbolic link to file
    ln -sfv "$DIRFILE" "$HOMEFILE"
  else
    # Remove $HOMEFILE
    rm -rv "$HOMEFILE" 2>/dev/null
    # Create symbolic link to directory
    ln -sv "$DIRFILE" "$HOMEFILE"
  fi
done
