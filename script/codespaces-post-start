#!/usr/bin/env bash
#
# Run by Codespaces after starting

# Update packages and enable universe/contrib repositories
if [[ -f /etc/os-release ]]; then
  if grep -qi "ubuntu" /etc/os-release; then
    software_repository="universe"
  elif grep -qi "debian" /etc/os-release; then
    software_repository="contrib"
  else
      echo "Unknown distribution"
      exit 1
  fi
  apt-get update \
    && apt-get install -yq software-properties-common \
    && add-apt-repository "$software_repository" --update
fi

# Install fish if not installed
if ! command -v fish >/dev/null; then
  apt-get install -yq fish \
    && FISH_PROMPT="function fish_prompt\n    set_color green\n    echo -n (whoami)\n    set_color normal\n    echo -n \":\"\n    set_color blue\n    echo -n (pwd)\n    set_color normal\n    echo -n \"> \"\nend\n" \
    && printf "%s" "$FISH_PROMPT" >> /etc/fish/functions/fish_prompt.fish \
    && printf "if type code-insiders > /dev/null 2>&1; and not type code > /dev/null 2>&1\n  alias code=code-insiders\nend" >> /etc/fish/conf.d/code_alias.fish
fi

# Install font-fira-code-nerd-font (Starship dependency)
git clone --filter=blob:none --sparse git@github.com:ryanoasis/nerd-fonts
cd nerd-fonts || return
git sparse-checkout add patched-fonts/FiraCode
./install.sh FiraCode

# Install Starship
curl -sS https://starship.rs/install.sh | sh -s -- -y

# Disable Starship container configuration
echo "
[container]
disabled = true" >> ~/.config/starship.toml

# Use default commit signing configuration
git config --global --unset user.signingkey
git config --global --unset gpg.format
git config --global --unset gpg.ssh.program
git config --global --unset commit.gpgsign

# Install VSCode extensions
script/install-vscode-extensions
